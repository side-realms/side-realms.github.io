---
title: "eBPF"
date: 2023-09-04T01:54:09+09:00
draft: true
---

スナックスティックが店から消えてて泣いた9月

## eBPF

コンテナセキュリティ(seccomp)関連で触ってみようと思ったがどちらかというと仮想化なのかな
eBPF(Extended Berkeley Packet Filter) は，Linux カーネルの中に実装された仮想的な CPU で動的にプログラムを実行できる技術．
カーネルモードで動作する仮想マシンに任意のコードを実行させて，カーネルのイベントをフックして
ユーザーランドに共有する．
カーネルを安全に拡張できる．
もともとはパケットフィルタリングの技術だったが，拡張された．
全然関係ないが github のアイコンがとてもかわいい.
前身は cBPF というらしい．

{{< figure src="https://github.com/isovalent/ebeedex/raw/main/images/tetragon-bee.png" class="center" width="500" caption="https://github.com/isovalent/ebeedex">}}

カーネル内部で動作するので，カーネルがパニックしないようにあらかじめ安全性が検証される．
eBPF が実行される手順は以下

1. eBPF プログラムを bpf システムコールでカーネル空間に流し込む
2. verifier で安全性検証
3. JIT コンパイル
4. フックポイントで実行

### Verifier

- 命令数チェック：BPF_MAXINSNS(4096) 以上あると NG
- ループ検出
- 到達できない命令があれば NG
- 境界内のメモリ，初期化済みのメモリだけにアクセスする
- 不正な型変換がない
- 命令の総数，分岐の総数が多すぎると NG

### BPF map

BPF で利用可能なデータ構造で，ユーザー，カーネル，BPF の間でデータの共有ができる．

### ヘルパー関数

カーネルの処理を呼び出す機能．
BPF が任意のカーネルの関数を呼び出せると困ることがある（セキュリティ，バージョン変化など）

### XDP

eBPF プログラムをネットワークドライバにアタッチして動作する．
NIC から受信したデータをカーネルのネットワークスタックよりも手前で処理する．
ユーザスペースのアプリケーションまでパケットが到達して処理する場合よりも
オーバヘッドの削減とか，バッファのコピーが不要だったりで高速な処理ができるようになる．

### BCC

eBPF のプログラム作成のためのフレームワークで，eBPF を簡単に記述するための C の書き方（？）を提供する．

### Cilium

kubernetes のネットワーキングに eBPF/XDP を使ったプロジェクト．
コンテナ間のネットワーキングやロードバランス，セキュリティポリシーを提供する．

## BCC やってみる

BCC を使ってみる
